<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor Obras</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDtCHaJKZU4y_tqF1CdSsqLyIM92Yd10jY&libraries=drawing"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <style>
        body {
            font-size: 0.8rem;
        }

        #map {
            height: 750px;
            width: 100%;
        }

        .chart-container {
            width: 20%;
            padding: 10px;
        }

        .info-box {
            width: 20%;
            padding: 20px;
            color: white;
            text-align: center;
            margin: 10px 5px;
            border-radius: 10px;
        }

        .info-box:nth-child(1) {
            background-color: #007bff;
        }

        .info-box:nth-child(2) {
            background-color: #28a745;
        }

        .info-box:nth-child(3) {
            background-color: #ffc107;
        }

        .info-box:nth-child(4) {
            background-color: #dc3545;
        }

        .info-box:nth-child(5) {
            background-color: #17a2b8;
        }

        .custom-popup {
            font-family: Arial, sans-serif;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #333;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 500px; /* Ajusta el ancho */
            max-height: 400px; /* Ajusta el alto */
            overflow-y: auto; /* Agrega scroll si el contenido es demasiado alto */
        }

        .custom-popup h4 {
            margin: 0 0 10px;
            font-size: 1.2rem;
            color: #007bff;
        }

        .custom-popup p {
            margin: 5px 0;
        }

        .custom-popup ul {
            padding-left: 20px;
        }

        .custom-popup canvas {
            width: 100% !important;
            height: auto !important;
        }

        .small-column {
            width: 250px; /* Ajusta el ancho según sea necesario */
            word-wrap: break-word;
            white-space: normal;
        }

        .small-chart {
            width: 15%; /* Ajusta el ancho según sea necesario */
            padding: 15px;
        }

        .badge {
            font-size: .7rem;
            margin-left: 10px;
        }

        .badge-success {
            color: #fff;
            background-color: #28a745;
        }

        .rounded-custom {
            border-radius: 10px; /* Ajusta este valor para más redondeo */
        }

        .bold-label {
            font-weight: bold;
            margin-top: 10px;
        }

        .wrap-dashNumber {
            text-align: left;
            padding-left: 60px;
            display: flex;
        }

        .ic-wrap-container {
            margin-right: 15px;
            padding-top: 15px;
        }

            .ic-wrap-container img {
                height: 45px;
            }
        /*        .wrap-dashNumber {
            text-align: left;
            padding-left: 60px;
            display: flex;
        }*/
        /*.wrap-dashNumber {
            text-align: center;
            padding-left: 0;
            display: flex;
            margin: 0 20px;*/ /* Ajusta el margen según sea necesario */
        /*}*/
        .wrap-dashNumber {
            text-align: center;
            padding-left: 0;
            display: flex;
            margin: 0 20px; /* Ajusta el margen según sea necesario */
            justify-content: center; /* Centra el contenido dentro del contenedor */
        }

        .ic-wrap-container {
            margin-right: 15px;
            padding-top: 15px;
        }

            .ic-wrap-container img {
                height: 45px;
            }

        .DashBignumber {
            font-size: 40px;
            font-weight: 700;
            font-family: "lora", sans-serif;
        }

        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .header-row div {
                margin: 0 10px;
            }

        .info-box {
            display: block;
            min-height: 90px;
            background: #fff;
            width: 100%;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .bg-green, .callout.callout-success, .alert-success, .label-success, .modal-success .modal-body {
            background-color: #00a65a !important;
        }

        .info-box-content {
            padding: 5px 10px;
            /*margin-left: 90px;*/
        }

        .info-box-text {
            text-transform: uppercase;
        }

        .info-box-number {
            display: block;
            font-weight: bold;
            font-size: 25px;
        }

        .popup-content {
            display: none;
            position: absolute;
            background-color: #fff;
            color: black;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 200px;
            top: 100%; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            border-radius: 10px; /* Añadir bordes redondeados */
        }

        .info-box:hover .popup-content {
            display: block;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.8); /* Fondo semitransparente */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        #loading img {
            width: 150px; /* Ajusta el tamaño del gif de carga */
            height: 150px;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .carousel-item img {
            width: 100%;
            height: 200px; /* Ajusta la altura según sea necesario */
            object-fit: cover; /* Ajusta la imagen para que cubra el contenedor */
        }
        th {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            white-space: normal;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <header class="bg-light py-3 mb-4">
        <div class="container d-flex align-items-center">
            <img src="~/Content/Iconos/MARCA_MINISTERIO2.png" alt="Logo" style="height: 50px; width: auto;" class="mr-3">
            <h2 class="m-0">Visor de Obra Pública de la Provincia de Mendoza</h2>
        </div>
    </header>
    <div class="container-fluid">
        <!-- Primer sector: Resumen -->
        <div class="row justify-content-center">
            <div class="wrap-dashNumber">
                <div class="ic-wrap-container">
                    <img src="~/Content/Iconos/ic-home-obras.svg" alt="icono">
                </div>
                <div class="desc-wrap">
                    <span class="DashBignumber" id="totalObra">0</span><br>
                    <span class="h3">OBRAS</span>
                </div>
            </div>
            <div class="wrap-dashNumber">
                <div class="ic-wrap-container">
                    <img src="~/Content/Iconos/ic-home-proy.svg" alt="icono">
                </div>
                <div class="desc-wrap">
                    <span class="DashBignumber" id="totalLicitacion">0</span><br>
                    <span class="h3">LICITACIONES</span>
                </div>
            </div>
        </div>
        <br />
        <div id="loading" style="display: none;">
            <img src="~/Content/Iconos/loading.gif" alt="Cargando..." />
        </div>

        <!-- Primer sector: Agrupación -->
        <div class="row">
            <div class="col-md-1"></div>
    <div class="col-md-2">
        <div class="info-box" onmouseover="showPopup(this)" onmouseout="hidePopup(this)">
            <span class="info-box-icon bg-green"></span>
            <img src="~/Content/Iconos/agua-y-cloacas.svg" alt="icono representativo a obras publicas" style="width: 40%;">
            <div class="info-box-content">
                <span class="info-box-text">AySAM</span>
                <span class="info-box-number" id="totalAySAM">0</span>
            </div>
            <div class="popup-content">
                <h4>AySAM</h4>
                <p id="totalObrasAySAM">Obras en Ejecución: 0</p>
                <p id="totalMontoAySAM">Monto: 0</p>
                <p id="totalAySAMLic">Obras en Licitación: 0</p>
                <p id="totalMontoAySAMLic">Monto: 0</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="info-box" onmouseover="showPopup(this)" onmouseout="hidePopup(this)">
            <span class="info-box-icon bg-green"></span>
            <img src="~/Content/Iconos/arquitectura.svg" alt="icono representativo a obras publicas" style="width: 40%;">
            <div class="info-box-content">
                <span class="info-box-text">Infraestructura</span>
                <span class="info-box-number" id="totalInfra">0</span>
            </div>
            <div class="popup-content">
                <h4>Infraestructura</h4>
                <p id="totalObrasInfra">Obras en Ejecución: 0</p>
                <p id="totalMontoInfra">Monto: 0</p>
                <p id="totalInfraLic">Obras en Licitación: 0</p>
                <p id="totalMontoInfraLic">Monto: 0</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="info-box" onmouseover="showPopup(this)" onmouseout="hidePopup(this)">
            <span class="info-box-icon bg-green"></span>
            <img src="~/Content/Iconos/vivienda.svg" alt="icono representativo a obras publicas" style="width: 30%;">
            <div class="info-box-content">
                <span class="info-box-text">IPV</span>
                <span class="info-box-number" id="totalIPV">0</span>
            </div>
            <div class="popup-content">
                <h4>IPV</h4>
                <p id="totalObrasIPV">Obras en Ejecución: 0</p>
                <p id="totalMontoIPV">Monto: 0</p>
                <p id="totalIPVLic">Obras en Licitación: 0</p>
                <p id="totalMontoIPVLic">Monto: 0</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="info-box" onmouseover="showPopup(this)" onmouseout="hidePopup(this)">
            <span class="info-box-icon bg-green"></span>
            <img src="~/Content/Iconos/obras-viales.svg" alt="icono representativo a obras publicas" style="width: 40%;">
            <div class="info-box-content">
                <span class="info-box-text">DPV</span>
                <span class="info-box-number" id="totalVialidad">0</span>
            </div>
            <div class="popup-content">
                <h4>DPV</h4>
                <p id="totalObrasVialidad">Obras en Ejecución: 0</p>
                <p id="totalMontoVialidad">Monto: 0</p>
                <p id="totalVialidadLic">Obras en Licitación: 0</p>
                <p id="totalMontoVialidadLic">Monto: 0</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="info-box" onmouseover="showPopup(this)" onmouseout="hidePopup(this)">
            <span class="info-box-icon bg-green"></span>
            <img src="~/Content/Iconos/iconoIrrigacion.png" alt="icono representativo a obras publicas" style="width: 40%;">
            <div class="info-box-content">
                <span class="info-box-text">Irrigación</span>
                <span class="info-box-number" id="totalIrrigacion">0</span>
            </div>
            <div class="popup-content">
                <h4>DPV</h4>
                <p id="totalObrasIrrigacion">Obras en Ejecución: 0</p>
                <p id="totalMontoIrrigacion">Monto: 0</p>
                <p id="totalIrrigacionLic">Obras en Licitación: 0</p>
                <p id="totalMontoIrrigacionLic">Monto: 0</p>
            </div>
        </div>
    </div>
</div>
            <!-- Segundo sector: Buscador -->
            <div class="row mb-3">
                <div class="col-12 d-flex justify-content-center">
                    <input type="text" id="nombreObra" class="form-control rounded-custom mr-2" placeholder="Ingrese el nombre de la obra" style="width: 300px;">
                    <label for="selectDepartamento" class="mr-2 bold-label mb-0">Departamento</label>
                    <select id="selectDepartamento" class="form-control rounded-custom mr-2" style="width: 150px;">
                        <option value="0">Todos</option>
                        <option value="1">Ciudad</option>
                        <option value="2">Godoy Cruz</option>
                        <option value="3">Guaymallén</option>
                        <option value="4">Gral Alvear</option>
                        <option value="5">Junín</option>
                        <option value="6">La Paz</option>
                        <option value="7">Las Heras</option>
                        <option value="8">Lavalle</option>
                        <option value="9">Luján</option>
                        <option value="10">Maipú</option>
                        <option value="11">Malargüe</option>
                        <option value="12">Rivadavia</option>
                        <option value="13">San Carlos</option>
                        <option value="14">San Martín</option>
                        <option value="15">San Rafael</option>
                        <option value="16">Santa Rosa</option>
                        <option value="17">Tunuyan</option>
                        <option value="18">Tupungato</option>
                    </select>
                    <label for="selectOrganismo" class="mr-2 bold-label mb-0">Dependencia</label>
                    <select id="selectOrganismo" class="form-control rounded-custom mr-2" style="width: 150px;">
                        <option value="0">Todos</option>
                        <option value="4">IPV</option>
                        <option value="14">Aysam</option>
                        <option value="9">Dirección Provincial Vialidad</option>
                        <option value="2">Infraestructura</option>
                        <option value="20">Irrigación</option>
                    </select>
                    <label for="selectEstado" class="mr-2 bold-label mb-0">Estado</label>
                    <select id="selectEstado" class="form-control rounded-custom mr-2" style="width: 150px;">
                        <option value="1">En Obra</option>
                        <option value="2">Licitacion</option>
                    </select>
                    <button id="btnBuscar" class="btn btn-success rounded-custom text-white">Buscar</button>
                    <button id="btnExportar" class="btn btn-info rounded-custom text-white">Exportar</button>
                </div>
            </div>

            <!-- Tercer sector: Mapa de Google -->
            <div class="row">
                <div class="col-12">
                    <div id="map"></div>
                </div>
            </div>

            <!-- Cuarto sector: Grilla -->
            <div class="row">
                <div class="col-12">
                    <table class="table table-striped" id="obrasTable">
                        <thead>
                            <tr>
                                <th class="small-column">Nombre de Obra</th>
                                <th>Estado</th>
                                <th>Dependencia</th>
                                <th>Fecha Publicación</th>
                                <th>Fecha Apertura</th>
                                <th>Departamento</th>
                                <th>Monto Contrato Básico</th>
                                <th>Avance</th>
                                <th>Empresa Contratista</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Estimada Fin</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <!-- Paginación -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Aquí se generarán los elementos de paginación dinámicamente -->
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- Modal de Bootstrap -->
            <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="infoModalLabel">Información de la Obra</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Aquí se llenará la información de la obra -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var loadingElement = document.getElementById('loading');
            /*var errorMessageElement = document.getElementById('error-message');*/
            var currentPage = 1;
            var pageSize = 10;
            var maxVisiblePages = 10; // Número máximo de páginas visibles en la paginación

            // Mostrar el indicador de carga
            loadingElement.style.display = 'block';

            // Realizar la llamada fetch al endpoint TOTAL OBRAS
            fetch('@Url.Content("~/api/Obra/BuscarTotalesObras")')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error de Red');
                    }
                    return response.json();
                })
                .then(data => {
                    //console.log(data);
                    var totalObra = data.cantidadObraEjecucion;
                    var totalLicitacion = data.cantidadObraLicitacion;
                    document.getElementById('totalObra').textContent = totalObra;
                    document.getElementById('totalLicitacion').textContent = totalLicitacion;
                })
                .catch(error => {
                    console.error('Error al obtener los datos:', error);
                });

            // Realizar la llamada fetch al endpoint OBRAS POR ORGANISMO
            fetch('@Url.Content("~/api/Obra/BuscarTotalesOrganismo")')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error de Red');
                    }
                    return response.json();
                })
                .then(data => {
                    data.forEach(item => {
                        console.log(item);
                        if (item.idOrganismo === 14) {
                            document.getElementById('totalAySAM').textContent = item.cantidadObraEjecucion;
                            document.getElementById('totalObrasAySAM').textContent ='Obras en Ejecución: '+ item.cantidadObraEjecucion;
                            document.getElementById('totalMontoAySAM').textContent = 'Monto: $ ' + item.montoObraEjecucion.toLocaleString('es-ES');
                            document.getElementById('totalAySAMLic').textContent = 'Obras en Licitación: ' + item.cantidadObraLicitacion;
                            document.getElementById('totalMontoAySAMLic').textContent = 'Monto: $ ' + item.montoObraLicitacion.toLocaleString('es-ES');
                        }
                        if (item.idOrganismo === 4) {
                            document.getElementById('totalIPV').textContent = item.cantidadObraEjecucion;
                            document.getElementById('totalObrasIPV').textContent = 'Obras en Ejecución: ' + item.cantidadObraEjecucion;
                            document.getElementById('totalMontoIPV').textContent = 'Monto: $ ' + item.montoObraEjecucion.toLocaleString('es-ES');
                            document.getElementById('totalIPVLic').textContent = 'Obras en Licitación: ' + item.cantidadObraLicitacion;
                            document.getElementById('totalMontoIPVLic').textContent = 'Monto: $ ' + item.montoObraLicitacion.toLocaleString('es-ES');
                        }
                        if (item.idOrganismo === 2) {
                            document.getElementById('totalInfra').textContent = item.cantidadObraEjecucion;
                            document.getElementById('totalObrasInfra').textContent = 'Obras en Ejecución: ' + item.cantidadObraEjecucion;
                            document.getElementById('totalMontoInfra').textContent = 'Monto: $ ' + item.montoObraEjecucion.toLocaleString('es-ES');
                            document.getElementById('totalInfraLic').textContent = 'Obras en Licitación: ' + item.cantidadObraLicitacion;
                            document.getElementById('totalMontoInfraLic').textContent = 'Monto: $ ' + item.montoObraLicitacion.toLocaleString('es-ES');
                        }
                        if (item.idOrganismo === 9) {
                            document.getElementById('totalVialidad').textContent = item.cantidadObraEjecucion;
                            document.getElementById('totalObrasVialidad').textContent = 'Obras en Ejecución: ' + item.cantidadObraEjecucion;
                            document.getElementById('totalMontoVialidad').textContent = 'Monto: $ ' + item.montoObraEjecucion.toLocaleString('es-ES');
                            document.getElementById('totalVialidadLic').textContent = 'Obras en Licitación: ' + item.cantidadObraLicitacion;
                            document.getElementById('totalMontoVialidadLic').textContent = 'Monto: $ ' + item.montoObraLicitacion.toLocaleString('es-ES');
                        }
                        if (item.idOrganismo === 20) {
                            document.getElementById('totalIrrigacion').textContent = item.cantidadObraEjecucion;
                            document.getElementById('totalObrasIrrigacion').textContent = 'Obras en Ejecución: ' + item.cantidadObraEjecucion;
                            document.getElementById('totalMontoIrrigacion').textContent = 'Monto: $ ' + item.montoObraEjecucion.toLocaleString('es-ES');
                            document.getElementById('totalIrrigacionLic').textContent = 'Obras en Licitación: ' + item.cantidadObraLicitacion;
                            document.getElementById('totalMontoIrrigacionLic').textContent = 'Monto: $ ' + item.montoObraLicitacion.toLocaleString('es-ES');
                        }
                    });
                })
                .catch(error => {
                    console.error('Error al obtener los datos:', error);
                })
                .finally(() => {
                    // Ocultar el indicador de carga
                    //loadingElement.style.display = 'none';
                });


            function fetchObras(page) {
                var nombreObra = document.getElementById('nombreObra').value;
                var selectDepartamento = document.getElementById('selectDepartamento').value;
                var selectOrganismo = document.getElementById('selectOrganismo').value;
                var selectEstado = document.getElementById('selectEstado').value;
                // Mostrar el indicador de carga
                loadingElement.style.display = 'block';
                //errorMessageElement.style.display = 'none';

                // Realizar la llamada fetch al endpoint BuscarObrasFiltradas
                fetch(`@Url.Content("~/api/Obra/BuscarObrasFiltradas")?nombreObra=${nombreObra}&selectDepartamento=${selectDepartamento}&selectOrganismo=${selectOrganismo}&selectEstado=${selectEstado}&page=${page}&pageSize=${pageSize}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error de Red');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data.items);
                        // Limpiar la tabla existente
                        var tbody = document.querySelector('#obrasTable tbody');
                        tbody.innerHTML = '';

                        // Llenar la tabla con los datos recibidos
                        data.items.forEach(obra => {
                            var row = document.createElement('tr');
                            row.classList.add('cursor-pointer');
                            row.innerHTML = `
                                <td class="small-column">${obra.nombreFormatted}</td>
                                <td>${obra.estadoFormatted}</td>
                                <td>${obra.dependenciaFormatted}</td>
                                <td>${obra.publicacionFormatted}</td>
                                <td>${obra.aperturaFormatted}</td>
                                <td>${obra.departamentoFormatted}</td>
                                <td>${obra.contratoFormatted}</td>
                                <td><span class="badge badge-success">${obra.avanceFormatted}</span></td>
                                <td>${obra.empresaFormatted}</td>
                                <td>${obra.inicioFormatted}</td>
                                <td>${obra.finFormatted}</td>
                            `;
                            row.addEventListener('click', function () {
                                showModal(obra);
                            });
                            tbody.appendChild(row);
                        });

                        // Actualizar controles de paginación
                        updatePagination(data.totalItems, page, pageSize);
                    })
                    .catch(error => {
                        console.error('Error al obtener los datos:', error);
                        //errorMessageElement.textContent = 'Error al obtener los datos de obras filtradas.';
                        //errorMessageElement.style.display = 'block';
                    })
                    .finally(() => {
                        // Ocultar el indicador de carga
                        loadingElement.style.display = 'none';
                    });
            }

            function updatePagination(totalItems, currentPage, pageSize) {
                var totalPages = Math.ceil(totalItems / pageSize);
                var paginationElement = document.getElementById('pagination');
                paginationElement.innerHTML = '';

                var startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                var endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                if (startPage > 1) {
                    var firstPageItem = document.createElement('li');
                    firstPageItem.className = 'page-item';
                    firstPageItem.innerHTML = `<a class="page-link" href="#">Primera</a>`;
                    firstPageItem.addEventListener('click', function (e) {
                        e.preventDefault();
                        fetchObras(1);
                    });
                    paginationElement.appendChild(firstPageItem);
                }

                for (var i = startPage; i <= endPage; i++) {
                    var pageItem = document.createElement('li');
                    pageItem.className = 'page-item' + (i === currentPage ? ' active' : '');
                    pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    pageItem.addEventListener('click', function (e) {
                        e.preventDefault();
                        fetchObras(parseInt(this.textContent));
                    });
                    paginationElement.appendChild(pageItem);
                }

                if (endPage < totalPages) {
                    var lastPageItem = document.createElement('li');
                    lastPageItem.className = 'page-item';
                    lastPageItem.innerHTML = `<a class="page-link" href="#">Última</a>`;
                    lastPageItem.addEventListener('click', function (e) {
                        e.preventDefault();
                        fetchObras(totalPages);
                    });
                    paginationElement.appendChild(lastPageItem);
                }
            }

            function showModal(obra) {
                var modalBody = document.querySelector('#infoModal .modal-body');
                modalBody.innerHTML = `
                    <p><strong>Nombre de Obra:</strong> ${obra.nombreFormatted}</p>
                    <p><strong>Estado:</strong> ${obra.estadoFormatted}</p>
                    <p><strong>Dependencia:</strong> ${obra.dependenciaFormatted}</p>
                    <p><strong>Departamento:</strong> ${obra.departamentoFormatted}</p>
                    <p><strong>Monto Contrato Básico:</strong> ${obra.contratoFormatted}</p>
                    <p><strong>Avance:</strong> ${obra.avanceFormatted}</p>
                    <p><strong>Contratista:</strong> ${obra.empresaFormatted}</p>
                    <p><strong>Inicio:</strong> ${obra.inicioFormatted}</p>
                    <p><strong>Fecha Estimada Fin:</strong> ${obra.finFormatted}</p>
                `;
                $('#infoModal').modal('show');
            }

            function fetchObrasMapa() {
                var nombreObra = document.getElementById('nombreObra').value;
                var selectDepartamento = document.getElementById('selectDepartamento').value;
                var selectOrganismo = document.getElementById('selectOrganismo').value;

                // Realizar la llamada fetch al endpoint BuscarObrasMapa
                fetch(`@Url.Content("~/api/Obra/BuscarObrasMapa")?nombreObra=${nombreObra}&selectDepartamento=${selectDepartamento}&selectOrganismo=${selectOrganismo}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error de Red');
                        }
                        return response.json();
                    })
                    .then(data => {
                        //console.log(data);
                        var obras = data.map(obra => ({
                            position: { lat: parseFloat(obra.latitudFormatted), lng: parseFloat(obra.longitudFormatted) },
                            nombre: obra.nombreFormatted,
                            estado: obra.estadoFormatted,
                            departamento: obra.departamentoFormatted,
                            montoContratado: obra.contratoFormatted,
                            domicilio: obra.direccionFormatted,
                            montoPagado: obra.totalPagadoFormatted,
                            avance: obra.avanceFormatted,
                            fechaInicio: obra.inicioFormatted,
                            fechaFin: obra.finFormatted,
                            icon: obra.icono,
                            archivos: obra.listaArchivos.map(url => ({ url: url, nombre: url.split('/').pop() })),
                            chartData: {
                                labels: obra.chartData.map(avance => avance.mesFormatted),
                                data: obra.chartData.map(avance => avance.avanceReal)
                            }
                        }));
                        //console.log('obras');
                        //console.log(obras);
                        initMap(obras);
                    })
                    .catch(error => {
                        console.error('Error al obtener los datos:', error);
                    });
            }

            function initMap(obras) {
                var mendoza = { lat: -32.889458, lng: -68.845839 };
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 7,
                    center: mendoza,
                    mapTypeId: 'satellite'
                });

                obras.forEach(function (obra) {
                    var archivosHtml = obra.archivos.map(function (archivo) {
                        return { url: archivo.url, nombre: archivo.nombre };
                    });

                    var contentString = `
                    <div class="custom-popup">
                        <p><span class="badge badge-primary">${obra.nombre}</span></p>
                        <p><strong>Estado:</strong><span class="badge badge-secondary"> ${obra.estado}</span></p>
                        <p><strong>Domicilio:</strong><span class="badge badge-secondary"> ${obra.domicilio}</span></p>
                        <p><strong>Departamento:</strong><span class="badge badge-secondary"> ${obra.departamento}</span></p>
                        <p><strong>Monto Contrato Básico:</strong><span class="badge badge-secondary"> ${obra.montoContratado}</span></p>
                        <p><strong>Avance:</strong><span class="badge badge-success"> ${obra.avance}</span></p>
                        <p><strong>Fecha Inicio:</strong><span class="badge badge-secondary"> ${obra.fechaInicio}</span></p>
                        <p><strong>Fecha Estimada Fin:</strong><span class="badge badge-secondary"> ${obra.fechaFin}</span></p>
                        <p><strong>Anexos:</strong> ${archivosHtml.length} ${archivosHtml.length > 0 ? `
                        <div id="carousel-${obra.nombre.replace(/\s+/g, '')}" class="carousel slide" data-ride="carousel">
                            <div class="carousel-inner">
                                ${archivosHtml.map((archivo, index) => `
                                <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                    <img src="${archivo.url}" class="d-block w-100" alt="${archivo.nombre}">
                                </div>
                                `).join('')}
                            </div>
                            <a class="carousel-control-prev" href="#carousel-${obra.nombre.replace(/\s+/g, '')}" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Anterior</span>
                            </a>
                            <a class="carousel-control-next" href="#carousel-${obra.nombre.replace(/\s+/g, '')}" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Próximo</span>
                            </a>
                        </div>
                        ` : '<p><span class="badge badge-secondary">No hay fotos</span></p>'}
                        <canvas id="lineChart-${obra.nombre.replace(/\s+/g, '')}"></canvas>
                    </div>
                    `;

                    var infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });

                    var marker = new google.maps.Marker({
                        position: obra.position,
                        map: map,
                        title: obra.nombre,
                        icon: obra.icon
                    });

                    marker.addListener('click', function () {
                        infowindow.open(map, marker);

                        // Espera a que el popup se haya abierto completamente
                        google.maps.event.addListenerOnce(infowindow, 'domready', function () {
                            // Inicializa el gráfico de líneas cuando se abre el popup
                            var ctx = document.getElementById(`lineChart-${obra.nombre.replace(/\s+/g, '')}`).getContext('2d');
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: obra.chartData.labels,
                                    datasets: [{
                                        label: 'Avance',
                                        data: obra.chartData.data,
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            min: 0,
                                            max: 100
                                        }
                                    }
                                }
                            });

                            // Inicializa el carrusel manualmente
                            $(`#carousel-${obra.nombre.replace(/\s+/g, '')}`).carousel();
                        });
                    });
                });




            }

            function fetchObrasExportar() {
                var nombreObra = document.getElementById('nombreObra').value;
                var selectDepartamento = document.getElementById('selectDepartamento').value;
                var selectOrganismo = document.getElementById('selectOrganismo').value;
                var selectEstado = document.getElementById('selectEstado').value;

                // Construir la URL con los parámetros
                var url = `@Url.Content("~/api/Obra/ExportarObrasFiltradas")?nombreObra=${nombreObra}&selectDepartamento=${selectDepartamento}&selectOrganismo=${selectOrganismo}&selectEstado=${selectEstado}`;

                // Realizar la llamada fetch al endpoint ExportarObrasFiltradas
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error de Red');
                        }
                        return response.blob(); // Obtener la respuesta como un Blob
                    })
                    .then(blob => {
                        // Crear un enlace para descargar el archivo
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'ObrasFiltradas.xlsx'; // Nombre del archivo
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    })
                    .catch(error => {
                        console.error('Error al exportar los datos:', error);
                    });
            }


            // Añadir evento click al botón Buscar
            document.getElementById('btnBuscar').addEventListener('click', function () {
                currentPage = 1;
                fetchObras(currentPage);
                fetchObrasMapa();
            });

            document.getElementById('btnExportar').addEventListener('click', function () {
                fetchObrasExportar();
            });
            // Inicializar la primera carga de datos
            fetchObras(currentPage);
            fetchObrasMapa();
        });

        function showPopup(element) {
            const popup = element.querySelector('.popup-content');
            popup.style.display = 'block';
        }

        function hidePopup(element) {
            const popup = element.querySelector('.popup-content');
            popup.style.display = 'none';
        }
    </script>


</body>
</html>

